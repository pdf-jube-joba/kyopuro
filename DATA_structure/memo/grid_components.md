# 問題の前提
bool の h*wの配列があるとき、 true の連結成分を数えたい。
（近傍は4方向とする。）
bfs でも dfs でもいいが、近傍のうちどれを探索し探索しなくていいかをいつ判定するかでかなり時間が変わるっぽい。

とりあえず queue を使う（幅優先探索）場合で考える。
作るのは、
```rust
fn count(grid: Vec<Vec<bool>>) -> Vec<Vec<Option<usize>>> {
    // 各マスごとにどの連結成分に含まれるかの番号を載せた配列を返す。
}
```
のような関数であるとする。

例えば、 `'#'` が `true` で `'.'` が `false` のとき、
```
##.#
.#.#
..#.
```
を考えると連結成分の番号の割り振りは次のようになる。
（ただし番号のつけ方には ambiguity があってよい。）
```
00.1
.0.1
..2.
```

# 2 つの実装方法の違いについて

## 共通する部分のプログラム
各 `(i,j): (usize, usize)` ごとに連結成分を探索すればいいので、次に使う連結成分の番号等やすでに探索済みかどうかをチェックする配列を用意すると次のような感じになる。

```rust
let mut grid_components: Vec<Vec<Option<usize>>> = vec![vec![None; w]; h];
let mut comp_num = 0;

for (i, j) in iproduct!(0..h, 0..w) {
    if grid_components[i][j].is_some() || !grid[i][j] {
        continue;
    }

    // ここで 各 (i,j) ごとに連結成分を計算する

    comp_num += 1;
}

grid_components
```

また、近傍を列挙する関数を次のように別に用意している。
```rust
fn adj((h, w): (usize, usize), (i, j): (usize, usize)) -> impl Iterator<Item = (usize, usize)> {
    vec![
        if i > 0 { Some((i - 1, j)) } else { None },
        if j > 0 { Some((i, j - 1)) } else { None },
        if j < w - 1 { Some((i, j + 1)) } else { None },
        if i < h - 1 { Some((i + 1, j)) } else { None },
    ]
    .into_iter()
    .flatten()
}
```
これら自体はそこまで問題ではない。

## 異なる部分のプログラム
先ほどのコメント部分に異なる2つの連結成分の計算の仕方を置く。
とは言っても、初見では（すくなくとも今の自分には）違いがそこまで明らかでない。

### 1
現在探索している点がすでに探索済みか `true` でない場合はスルーし、そうでない場合にはマークを付けた後近傍を探索させる。
```rust
let mut queue: VecDeque<(usize, usize)> = VecDeque::from_iter(vec![(i, j)]);

while let Some(pt) = queue.pop_front() {
    if !grid[pt.0][pt.1] || grid_components[pt.0][pt.1].is_some() {
        continue;
    }
    grid_components[pt.0][pt.1] = Some(comp_num);
    queue.extend(adj((h, w), pt));
}
```

### 2
queue には探索済みでないかつ `true` になっているもののみが詰め込まれているとして、
探索している点に探索をした後に queue に近傍を詰め込む段階で近傍をチェックしてしまう。

```rust
let mut queue: VecDeque<(usize, usize)> = VecDeque::from_iter(vec![(i, j)]);

while let Some(pt) = queue.pop_front() {
    grid_components[pt.0][pt.1] = Some(comp_num);
    queue.extend(
        adj((h, w), pt)
            .filter(|pt2| grid_components[pt2.0][pt2.1].is_none()
            && grid[pt2.0][pt2.1]
        ),
    );
}
```

# 考察と実験結果
## 考察
2番のほうがqueueに詰め込む前からチェックしているのでqueueが大きくならず早そうに思える。
また、queueに含まれる点はすべてvalidになるため、不変条件を考える際にも扱いやすいように思える。

## ベンチマーク
ベンチマーク取ったら違った。
しかも、かなり顕著に2番のほうが遅い。
特に、すべて `true` の場合で顕著な差が現れた。

# ちゃんとした考察をする？
## エミュレート
すべて `true` になっている3*3の配列で考える。
while の頭での pt + queue の中身・近傍を順に乗せる。
また、配列は `(i,j)` であらわさずに次のように番号が割り振られていると思って考える。
```
123
456
789
```

### 1

| queuetop | queue | adj |
| -------- | ----- | --- |
| 1 | [1 ]                          | [2, 4] |
| 2 | [2, 4]                        | [1, 3, 5] |
| 4 | [4, 1, 3, 5]                  | [1, 5, 7] |
| 1 | [1, 3, 5, 1, 5, 7]            | |
| 3 | [3, 5, 1, 5, 7]               | [2, 6] |
| 5 | [5, 1, 5, 7, 2, 6]            | [2, 4, 6, 8] |
| 1 | [1, 5, 7, 2, 6, 2, 4, 6, 8]   | |
| 5 | [5, 7, 2, 6, 2, 4, 6, 8]      | |
| 7 | [7, 2, 6, 2, 4, 6, 8]         | [4, 8] |
| 2 | [2, 6, 2, 4, 6, 8, 4, 8]      | |
| 6 | [6, 2, 4, 6, 8, 4, 8]         | [3, 5, 9] |
| 2 | [2, 4, 6, 8, 4, 8, 3, 5, 9]   | |
| 4 | [4, 6, 8, 4, 8, 3, 5, 9]      | |
| 6 | [6, 8, 4, 8, 3, 5, 9]         | |
| 8 | [8, 4, 8, 3, 5, 9]            | [5, 7, 9] |
| 4 | [4, 8, 3, 5, 9, 5, 7, 9]      | |
| 8 | [8, 3, 5, 9, 5, 7, 9]         | |
| 3 | [3, 5, 9, 5, 7, 9]            | |
| 5 | [5, 9, 5, 7, 9]               | |
| 9 | [9, 5, 7, 9]                  | [6, 8] |
| 5 | [5, 7, 9]                     | |
| 7 | [7, 9]                        | |
| 9 | [9 ]                          | |

23 回の操作

### 2
| queuetop | queue | filtered adj | adj |
| -------- | ----- | ------------ | --- |
| 1 | [1 ]               | [2, 4] | [2, 4] |
| 2 | [2, 4]             | [3, 5] | [1, 3, 5] |
| 4 | [4, 3, 5]          | [5, 7] | [1, 5, 7] |
| 3 | [3, 5, 5, 7]       | [6 ] | [2, 6] |
| 5 | [5, 5, 7, 6]       | [6, 8] | [2, 4, 6, 8] |
| 5 | [5, 7, 6, 6, 8]    | [6, 8] | [2, 4, 6, 8] |
| 7 | [7, 6, 6, 8, 6, 8] | [8 ] | [4, 8] |
| 6 | [6, 6, 8, 6, 8, 8] | [9 ] | [3, 5, 9] |
| 6 | [6, 8, 6, 8, 8, 9] | [9 ] | [3, 5, 9] |
| 8 | [8, 6, 8, 8, 9, 9] | [9 ] | [5, 7, 9] |
| 6 | [6, 8, 8, 9, 9, 9] | [9 ] | [3, 5, 9] |
| 8 | [8, 8, 9, 9, 9, 9] | [9 ] | [5, 7, 9] |
| 8 | [8, 9, 9, 9, 9, 9] | [9 ] | [5, 7, 9] |
| 9 | [9, 9, 9, 9, 9, 9] | [] | [6, 8] |
| 9 | [9, 9, 9, 9, 9]    | [] | [6, 8] |
| 9 | [9, 9, 9, 9]       | [] | [6, 8] |
| 9 | [9, 9, 9]          | [] | [6, 8] |
| 9 | [9, 9]             | [] | [6, 8] |
| 9 | [9 ]               | [] | [6, 8] |
23 回の操作

3 * 3 の場合には同じになった。

## エミュレート2
4*4でやってみる？
```
0123
4567
89ab
cdef
```

### 1
| queuetop | queue | adj |
| -------- | ----- | --- |
| 0 | [0 ] | [1, 4] |
| 1 | [1, 4] | [0, 2, 5] |
| 4 | [4, 0, 2, 5] | [0, 5, 8] |
| 0 | [0, 2, 5, 0, 5, 8] |  |
| 2 | [2, 5, 0, 5, 8] | [1, 3, 6] |
| 5 | [5, 0, 5, 8, 1, 3, 6] | [1, 4, 6, 9] |
| 0 | [0, 5, 8, 1, 3, 6, 1, 4, 6, 9] |  |
| 5 | [5, 8, 1, 3, 6, 1, 4, 6, 9] |  |
| 8 | [8, 1, 3, 6, 1, 4, 6, 9] | [4, 9, c] |
| 1 | [1, 3, 6, 1, 4, 6, 9, 4, 9, c] |  |
| 3 | [3, 6, 1, 4, 6, 9, 4, 9, c] | [2, 7] |
| 6 | [6, 1, 4, 6, 9, 4, 9, c, 2, 7] | [2, 5, 7, a] |
| 1 | [1, 4, 6, 9, 4, 9, c, 2, 7, 2, 5, 7, a] |  |
| 4 | [4, 6, 9, 4, 9, c, 2, 7, 2, 5, 7, a] |  |
| 6 | [6, 9, 4, 9, c, 2, 7, 2, 5, 7, a] |  |
| 9 | [9, 4, 9, c, 2, 7, 2, 5, 7, a] | [5, 8, a, d] |
| 4 | [4, 9, c, 2, 7, 2, 5, 7, a, 5, 8, a, d] |  |
| 9 | [9, c, 2, 7, 2, 5, 7, a, 5, 8, a, d] |  |
| c | [c, 2, 7, 2, 5, 7, a, 5, 8, a, d] | [8, d] |
| 2 | [2, 7, 2, 5, 7, a, 5, 8, a, d, 8, d] |  |
| 7 | [7, 2, 5, 7, a, 5, 8, a, d, 8, d] | [3, 6, b] |
| 2 | [2, 5, 7, a, 5, 8, a, d, 8, d, 3, 6, b] |  |
| 5 | [5, 7, a, 5, 8, a, d, 8, d, 3, 6, b] |  |
| 7 | [7, a, 5, 8, a, d, 8, d, 3, 6, b] |  |
| a | [a, 5, 8, a, d, 8, d, 3, 6, b] | [6, 9, b, e] |
| 5 | [5, 8, a, d, 8, d, 3, 6, b, 6, 9, b, e] |  |
| 8 | [8, a, d, 8, d, 3, 6, b, 6, 9, b, e] |  |
| a | [a, d, 8, d, 3, 6, b, 6, 9, b, e] |  |
| d | [d, 8, d, 3, 6, b, 6, 9, b, e] | [9, c, e] |
| 8 | [8, d, 3, 6, b, 6, 9, b, e, 9, c, e] |  |
| d | [d, 3, 6, b, 6, 9, b, e, 9, c, e] |  |
| 3 | [3, 6, b, 6, 9, b, e, 9, c, e] |  |
| 6 | [6, b, 6, 9, b, e, 9, c, e] |  |
| b | [b, 6, 9, b, e, 9, c, e] | [7, a, f] |
| 6 | [6, 9, b, e, 9, c, e, 7, a, f] |  |
| 9 | [9, b, e, 9, c, e, 7, a, f] |  |
| b | [b, e, 9, c, e, 7, a, f] |  |
| e | [e, 9, c, e, 7, a, f] | [a, d, f] |
| 9 | [9, c, e, 7, a, f, a, d, f] |  |
| c | [c, e, 7, a, f, a, d, f] |  |
| e | [e, 7, a, f, a, d, f] |  |
| 7 | [7, a, f, a, d, f] |  |
| a | [a, f, a, d, f] |  |
| f | [f, a, d, f] | [b, e] |
| a | [a, d, f, b, e] |  |
| d | [d, f, b, e] |  |
| f | [f, b, e] |  |
| b | [b, e] |  |
| e | [e ] |  |

### 2
| queuetop | queue | filtered adj | adj |
| -------- | ----- | ------------ | --- |
| 0 | [0] | [1, 4] | [1, 4] |
| 1 | [1, 4] | [2, 5] | [0, 2, 5] |
| 4 | [4, 2, 5] | [5, 8] | [0, 5, 8] |
| 2 | [2, 5, 5, 8] | [3, 6] | [1, 3, 6] |
| 5 | [5, 5, 8, 3, 6] | [6, 9] | [1, 4, 6, 9] |
| 5 | [5, 8, 3, 6, 6, 9] | [6, 9] | [1, 4, 6, 9] |
| 8 | [8, 3, 6, 6, 9, 6, 9] | [9, c] | [4, 9, c] |
| 3 | [3, 6, 6, 9, 6, 9, 9, c] | [7] | [2, 7] |
| 6 | [6, 6, 9, 6, 9, 9, c, 7] | [7, a] | [2, 5, 7, a] |
| 6 | [6, 9, 6, 9, 9, c, 7, 7, a] | [7, a] | [2, 5, 7, a] |
| 9 | [9, 6, 9, 9, c, 7, 7, a, 7, a] | [a, d] | [5, 8, a, d] |
| 6 | [6, 9, 9, c, 7, 7, a, 7, a, a, d] | [7, a] | [2, 5, 7, a] |
| 9 | [9, 9, c, 7, 7, a, 7, a, a, d, 7, a] | [a, d] | [5, 8, a, d] |
| 9 | [9, c, 7, 7, a, 7, a, a, d, 7, a, a, d] | [a, d] | [5, 8, a, d] |
| c | [c, 7, 7, a, 7, a, a, d, 7, a, a, d, a, d] | [d] | [8, d] |
| 7 | [7, 7, a, 7, a, a, d, 7, a, a, d, a, d, d] | [b] | [3, 6, b] |
| 7 | [7, a, 7, a, a, d, 7, a, a, d, a, d, d, b] | [b] | [3, 6, b] |
| a | [a, 7, a, a, d, 7, a, a, d, a, d, d, b, b] | [b, e] | [6, 9, b, e] |
| 7 | [7, a, a, d, 7, a, a, d, a, d, d, b, b, b, e] | [b] | [3, 6, b] |
| a | [a, a, d, 7, a, a, d, a, d, d, b, b, b, e, b] | [b, e] | [6, 9, b, e] |
| a | [a, d, 7, a, a, d, a, d, d, b, b, b, e, b, b, e] | [b, e] | [6, 9, b, e] |
| d | [d, 7, a, a, d, a, d, d, b, b, b, e, b, b, e, b, e] | [e] | [9, c, e] |
| 7 | [7, a, a, d, a, d, d, b, b, b, e, b, b, e, b, e, e] | [b] | [3, 6, b] |
| a | [a, a, d, a, d, d, b, b, b, e, b, b, e, b, e, e, b] | [b, e] | [6, 9, b, e] |
| a | [a, d, a, d, d, b, b, b, e, b, b, e, b, e, e, b, b, e] | [b, e] | [6, 9, b, e] |
| d | [d, a, d, d, b, b, b, e, b, b, e, b, e, e, b, b, e, b, e] | [e] | [9, c, e] |
| a | [a, d, d, b, b, b, e, b, b, e, b, e, e, b, b, e, b, e, e] | [b, e] | [6, 9, b, e] |
| d | [d, d, b, b, b, e, b, b, e, b, e, e, b, b, e, b, e, e, b, e] | [e] | [9, c, e] |
| d | [d, b, b, b, e, b, b, e, b, e, e, b, b, e, b, e, e, b, e, e] | [e] | [9, c, e] |
| b | [b, b, b, e, b, b, e, b, e, e, b, b, e, b, e, e, b, e, e, e] | [f] | [7, a, f] |
| b | [b, b, e, b, b, e, b, e, e, b, b, e, b, e, e, b, e, e, e, f] | [f] | [7, a, f] |
| b | [b, e, b, b, e, b, e, e, b, b, e, b, e, e, b, e, e, e, f, f] | [f] | [7, a, f] |
| e | [e, b, b, e, b, e, e, b, b, e, b, e, e, b, e, e, e, f, f, f] | [f] | [a, d, f] |
| b | [b, b, e, b, e, e, b, b, e, b, e, e, b, e, e, e, f, f, f, f] | [f] | [7, a, f] |
| b | [b, e, b, e, e, b, b, e, b, e, e, b, e, e, e, f, f, f, f, f] | [f] | [7, a, f] |
| e | [e, b, e, e, b, b, e, b, e, e, b, e, e, e, f, f, f, f, f, f] | [f] | [a, d, f] |
| b | [b, e, e, b, b, e, b, e, e, b, e, e, e, f, f, f, f, f, f, f] | [f] | [7, a, f] |
| e | [e, e, b, b, e, b, e, e, b, e, e, e, f, f, f, f, f, f, f, f] | [f] | [a, d, f] |
| e | [e, b, b, e, b, e, e, b, e, e, e, f, f, f, f, f, f, f, f, f] | [f] | [a, d, f] |
| b | [b, b, e, b, e, e, b, e, e, e, f, f, f, f, f, f, f, f, f, f] | [f] | [7, a, f] |
| b | [b, e, b, e, e, b, e, e, e, f, f, f, f, f, f, f, f, f, f, f] | [f] | [7, a, f] |
| e | [e, b, e, e, b, e, e, e, f, f, f, f, f, f, f, f, f, f, f, f] | [f] | [a, d, f] |
| b | [b, e, e, b, e, e, e, f, f, f, f, f, f, f, f, f, f, f, f, f] | [f] | [7, a, f] |
| e | [e, e, b, e, e, e, f, f, f, f, f, f, f, f, f, f, f, f, f, f] | [f] | [a, d, f] |
| e | [e, b, e, e, e, f, f, f, f, f, f, f, f, f, f, f, f, f, f, f] | [f] | [a, d, f] |
| b | [b, e, e, e, f, f, f, f, f, f, f, f, f, f, f, f, f, f, f, f] | [f] | [7, a, f] |
| e | [e, e, e, f, f, f, f, f, f, f, f, f, f, f, f, f, f, f, f, f] | [f] | [a, d, f] |
| e | [e, e, f, f, f, f, f, f, f, f, f, f, f, f, f, f, f, f, f, f] | [f] | [a, d, f] |
| e | [e, f, f, f, f, f, f, f, f, f, f, f, f, f, f, f, f, f, f, f] | [f] | [a, d, f] |
| f | [f, f, f, f, f, f, f, f, f, f, f, f, f, f, f, f, f, f, f, f] | [] | [b, e] |
| f | [f, f, f, f, f, f, f, f, f, f, f, f, f, f, f, f, f, f, f] | [] | [b, e] |
| f | [f, f, f, f, f, f, f, f, f, f, f, f, f, f, f, f, f, f] | [] | [b, e] |
| f | [f, f, f, f, f, f, f, f, f, f, f, f, f, f, f, f, f] | [] | [b, e] |
| f | [f, f, f, f, f, f, f, f, f, f, f, f, f, f, f, f] | [] | [b, e] |
| f | [f, f, f, f, f, f, f, f, f, f, f, f, f, f, f] | [] | [b, e] |
| f | [f, f, f, f, f, f, f, f, f, f, f, f, f, f] | [] | [b, e] |
| f | [f, f, f, f, f, f, f, f, f, f, f, f, f] | [] | [b, e] |
| f | [f, f, f, f, f, f, f, f, f, f, f, f] | [] | [b, e] |
| f | [f, f, f, f, f, f, f, f, f, f, f] | [] | [b, e] |
| f | [f, f, f, f, f, f, f, f, f, f] | [] | [b, e] |
| f | [f, f, f, f, f, f, f, f, f] | [] | [b, e] |
| f | [f, f, f, f, f, f, f, f] | [] | [b, e] |
| f | [f, f, f, f, f, f, f] | [] | [b, e] |
| f | [f, f, f, f, f, f] | [] | [b, e] |
| f | [f, f, f, f, f] | [] | [b, e] |
| f | [f, f, f, f] | [] | [b, e] |
| f | [f, f, f] | [] | [b, e] |
| f | [f, f] | [] | [b, e] |
| f | [f] | [] | [b, e] |

## 結果
巨大数で見たことある増え方をしていた。
